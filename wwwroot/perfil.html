<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/jpeg" href="/favicon.png">
    <title>Meu Perfil | Facility.IA</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style-master.css">
    <link rel="stylesheet" href="responsive.css">
</head>

<body>

    <div id="particles-js" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1;"></div>

    <div class="mobile-header">
        <i class="fas fa-bars menu-trigger" onclick="toggleSidebar()"></i>
        <div class="mobile-title">MEU PERFIL</div>
        <div style="width: 32px;"></div>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="layout">
        <nav class="sidebar" id="sidebar">
            <div class="logo desktop-only" style="padding-left: 5px;">FACILITY<span>.IA</span></div>

            <a href="dashboard.html" class="nav-btn"><i class="fas fa-th-large"></i> Início</a>
            <a href="escolher_agente.html" class="nav-btn"><i class="fas fa-bolt"></i> Assistentes</a>
            <a href="meus_prompts.html" class="nav-btn"><i class="fas fa-terminal"></i> Prompts/Agentes</a>
            <a href="planos.html" class="nav-btn"><i class="fas fa-layer-group"></i> Planos</a>
            <a href="prompts.html" class="nav-btn"><i class="fas fa-lightbulb"></i> Como Funciona</a>
            <a href="configuracoes.html" class="nav-btn"><i class="fas fa-cog"></i> Configurações</a>

            <div id="adminArea"
                style="display: none; flex-direction: column; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 15px; padding-top: 15px;">
                <div
                    style="font-size: 0.7rem; color: #666; margin-bottom: 10px; padding-left: 10px; text-transform: uppercase; font-weight:bold;">
                    Administração</div>

                <a href="treinamento.html" class="nav-btn"><i class="fas fa-brain"></i> Treinamento</a>
                <a href="gerenciar_agentes.html" class="nav-btn" style="color: #00F3FF;"><i class="fas fa-robot"></i>
                    Agentes</a>
                <a href="admin.html" class="nav-btn" style="color: #ffcc00;"><i class="fas fa-lock"></i> Painel
                    Admin</a>
            </div>

            <div class="spacer"></div>

            <div id="dashboardPlanCard" class="card-plan-status"
                style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; transition: all 0.3s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; font-size:0.9rem; color:#aaa; font-weight:600;">SEU PLANO</h3>
                    <span id="planBadge"
                        style="background:#00ff88; color:black; padding:3px 10px; border-radius:12px; font-weight:bold; font-size:0.7rem;">INICIANTE</span>
                </div>
                <div style="margin-top:10px;">
                    <h2 id="planName" style="margin:0; font-size:1.4rem;">Iniciante</h2>
                </div>
                <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;"
                    id="upgradeSection">
                    <a href="planos.html"
                        style="color:#00ff88; text-decoration:none; font-size:0.85rem; font-weight:bold; display:flex; align-items:center; gap:5px;">
                        <i class="fas fa-arrow-up"></i> Fazer Upgrade
                    </a>
                </div>
            </div>

            <a href="perfil.html" class="user-mini">
                <div class="avatar" id="sidebarAvatar">U</div>
                <div style="font-size:0.85rem; color:#ccc; overflow:hidden;">
                    <div id="sidebarUserName"
                        style="white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:140px;">Usuário
                    </div>
                    <div style="color:#666; font-size:0.75rem;">Ver Perfil</div>
                </div>
            </a>

            <a href="#" onclick="fazerLogout()" class="nav-btn"
                style="color:#ff5555; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                <i class="fas fa-sign-out-alt"></i> Sair
            </a>
        </nav>

        <main class="content">
            <div style="max-width: 800px; margin: 0 auto;">

                <div class="profile-card">
                    <div
                        style="position: absolute; top:0; left:0; width:100%; height:100px; background: linear-gradient(90deg, var(--primary-dim), transparent);">
                    </div>

                    <div class="profile-avatar-container">
                        <div id="mainAvatar" class="profile-avatar-large"
                            style="background-size: cover; background-position: center;">U</div>
                        <label for="fileUpload" class="camera-btn">
                            <i class="fas fa-camera" style="font-size: 0.9rem;"></i>
                        </label>
                        <input type="file" id="fileUpload" style="display: none;" accept="image/*"
                            onchange="uploadPhoto(this)">
                    </div>

                    <h2 id="displayName" style="margin: 0; color: white;">Carregando...</h2>
                    <p id="displayEmail" style="color: #888; margin-top: 5px;">...</p>

                    <div style="margin-top: 30px; display: flex; justify-content: center; gap: 40px;">
                        <div>
                            <div id="displayPlan" style="font-size: 1.5rem; font-weight: bold; color: white;">Free</div>
                            <div style="font-size: 0.8rem; color: #666; text-transform: uppercase;">Plano Atual</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">0</div>
                            <div style="font-size: 0.8rem; color: #666; text-transform: uppercase;">Prompts Criados
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    style="background: #161b22; border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 30px;">
                    <h3
                        style="margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 25px;">
                        Dados Pessoais</h3>

                    <div class="profile-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="color: #ccc; font-size: 0.9rem;">Nome Completo</label>
                            <input type="text" id="inputName" class="modal-input" style="margin-bottom:0;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="color: #ccc; font-size: 0.9rem;">E-mail</label>
                            <input type="email" id="inputEmail" disabled class="modal-input"
                                style="margin-bottom:0; background: rgba(255,255,255,0.05); cursor: not-allowed; color:#888;">
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: right;">
                        <button id="btnSave" onclick="saveProfile()"
                            style="background: var(--primary); color: black; border: none; padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.3s;">Salvar
                            Alterações</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="script.js"></script>

    <script>
        // Função de upload conectada ao backend
        async function uploadPhoto(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);

                // Feedback visual imediato
                showToast('Enviando foto...', 'info');

                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/upload-photo`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }, // Sem Content-Type, o browser define multipart
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Atualiza a visualização com a URL retornada pelo servidor
                        const avatar = document.getElementById('mainAvatar');
                        avatar.innerText = "";

                        // Normalização da URL
                        const normalizedBaseUrl = API_BASE_URL.endsWith('/') ? API_BASE_URL.slice(0, -1) : API_BASE_URL;
                        const normalizedPictureUrl = data.url.startsWith('/') ? data.url : '/' + data.url;
                        avatar.style.backgroundImage = `url('${normalizedBaseUrl}${normalizedPictureUrl}')`;

                        showToast('Foto atualizada com sucesso!', 'success');
                    } else {
                        showToast('Falha no envio da imagem.', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    showToast('Erro ao conectar ao servidor.', 'error');
                }
            }
        }

        // Salvar alterações de texto (Nome)
        async function saveProfile() {
            const btn = document.getElementById('btnSave');
            const newName = document.getElementById('inputName').value;

            if (!newName.trim()) {
                showToast('O nome não pode estar vazio.', 'warning');
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Salvando...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    document.getElementById('displayName').innerText = newName;

                    // Atualiza localmente para evitar refresh
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    userData.name = newName;
                    localStorage.setItem('userData', JSON.stringify(userData));

                    btn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
                    btn.style.background = '#00cc88';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = 'Salvar Alterações';
                        btn.style.background = 'var(--primary)';
                    }, 2000);
                } else {
                    showToast('Erro ao salvar perfil.', 'error');
                    btn.disabled = false;
                    btn.innerText = 'Salvar Alterações';
                }
            } catch (error) {
                console.error(error);
                showToast('Erro de conexão.', 'error');
                btn.disabled = false;
                btn.innerText = 'Salvar Alterações';
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Agente | Facility.IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style-master.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="config.js"></script>

    <script>
        const token = localStorage.getItem('token');

        // --- INÍCIO DA VALIDAÇÃO DE ADMIN ---
        if (!token) {
            window.location.href = 'login.html';
        } else {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(window.atob(base64));

                const role = payload["role"] || payload["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];

                if (role !== 'admin') {
                    alert("Acesso Negado.");
                    window.location.href = 'dashboard.html';
                }
            } catch (e) {
                window.location.href = 'login.html';
            }
        }
        // --- FIM DA VALIDAÇÃO ---

        // Código original que captura o ID continua aqui em baixo:
        const urlParams = new URLSearchParams(window.location.search);
        const agentId = urlParams.get('id');
        if (!agentId) window.location.href = 'gerenciar_agentes.html';
    </script>

    <style>
        /* Layout Grid para Desktop */
        .edit-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (max-width: 900px) {
            .edit-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Cards Estilizados */
        .glass-card {
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            color: #00F3FF;
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        /* Área de Upload Drag & Drop */
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #00F3FF;
            background: rgba(0, 243, 255, 0.05);
        }

        .upload-zone i {
            font-size: 2.5rem;
            color: #666;
            margin-bottom: 10px;
            transition: 0.3s;
        }

        .upload-zone:hover i {
            color: #00F3FF;
            transform: scale(1.1);
        }

        /* Lista de Arquivos */
        .file-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px 15px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .file-card:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(0, 243, 255, 0.3);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #ddd;
        }

        .file-icon {
            color: #ffcc00;
            font-size: 1.2rem;
        }

        .btn-delete {
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            padding: 5px;
        }

        .btn-delete:hover {
            color: #ff5555;
            transform: scale(1.1);
        }

        /* Grid de Ícones */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .icon-option {
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a2a40;
            border-radius: 6px;
            cursor: pointer;
            color: #888;
            border: 2px solid transparent;
        }

        .icon-option:hover {
            color: white;
            background: #3a3a50;
        }

        .icon-option.selected {
            border-color: #00F3FF;
            color: #00F3FF;
            background: rgba(0, 243, 255, 0.1);
        }

        /* Scrollbar Personalizada */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00F3FF;
        }
    </style>
</head>

<body>
    <div id="particles-js" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1;"></div>

    <div class="layout">
        <nav class="sidebar" id="sidebar">
            <div class="logo desktop-only" style="padding-left: 5px;">FACILITY<span>.IA</span></div>

            <a href="dashboard.html" class="nav-btn"><i class="fas fa-th-large"></i> Início</a>
            <a href="escolher_agente.html" class="nav-btn"><i class="fas fa-bolt"></i> Assistentes</a>
            <a href="meus_prompts.html" class="nav-btn"><i class="fas fa-terminal"></i> Prompts/Agentes</a>
            <a href="planos.html" class="nav-btn"><i class="fas fa-layer-group"></i> Planos</a>
            <a href="prompts.html" class="nav-btn"><i class="fas fa-lightbulb"></i> Como Funciona</a>
            <a href="configuracoes.html" class="nav-btn"><i class="fas fa-cog"></i> Configurações</a>

            <div id="adminArea"
                style="display: none; flex-direction: column; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 15px; padding-top: 15px;">
                <div
                    style="font-size: 0.7rem; color: #666; margin-bottom: 10px; padding-left: 10px; text-transform: uppercase; font-weight:bold;">
                    Administração</div>

                <a href="treinamento.html" class="nav-btn"><i class="fas fa-brain"></i> Treinamento</a>
                <a href="gerenciar_agentes.html" class="nav-btn" style="color: #00F3FF;"><i class="fas fa-robot"></i>
                    Agentes</a>
                <a href="admin.html" class="nav-btn" style="color: #ffcc00;"><i class="fas fa-lock"></i> Painel
                    Admin</a>
            </div>

            <div class="spacer"></div>

            <div id="dashboardPlanCard" class="card-plan-status"
                style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; transition: all 0.3s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; font-size:0.9rem; color:#aaa; font-weight:600;">SEU PLANO</h3>
                    <span id="planBadge"
                        style="background:#00ff88; color:black; padding:3px 10px; border-radius:12px; font-weight:bold; font-size:0.7rem;">INICIANTE</span>
                </div>
                <div style="margin-top:10px;">
                    <h2 id="planName" style="margin:0; font-size:1.4rem;">Iniciante</h2>
                </div>
                <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;"
                    id="upgradeSection">
                    <a href="planos.html"
                        style="color:#00ff88; text-decoration:none; font-size:0.85rem; font-weight:bold; display:flex; align-items:center; gap:5px;">
                        <i class="fas fa-arrow-up"></i> Fazer Upgrade
                    </a>
                </div>
            </div>

            <a href="perfil.html" class="user-mini">
                <div class="avatar" id="sidebarAvatar">U</div>
                <div style="font-size:0.85rem; color:#ccc; overflow:hidden;">
                    <div id="sidebarUserName"
                        style="white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:140px;">Usuário
                    </div>
                    <div style="color:#666; font-size:0.75rem;">Ver Perfil</div>
                </div>
            </a>

            <a href="#" onclick="fazerLogout()" class="nav-btn"
                style="color:#ff5555; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                <i class="fas fa-sign-out-alt"></i> Sair
            </a>
        </nav>

        <main class="content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: white; margin: 0;">Editar <span style="color: #00F3FF;">Agente</span></h2>
                <button onclick="salvarAlteracoes()" class="btn-primary" style="padding: 10px 25px;">
                    <i class="fas fa-save"></i> Salvar Tudo
                </button>
            </div>

            <div class="edit-layout">
                <div class="glass-card">
                    <div class="section-title"><i class="fas fa-user-cog"></i> Configurações do Agente</div>

                    <div class="form-group">
                        <label style="color: #ccc; font-size: 0.9rem;">Ícone de Identificação</label>
                        <div class="icon-grid" id="iconContainer"></div>
                        <input type="hidden" id="selectedIcon">
                    </div>

                    <div class="form-group">
                        <label style="color: #ccc;">Nome do Assistente</label>
                        <input type="text" id="agentName" class="auth-input" style="width: 100%;"
                            placeholder="Ex: Consultor Jurídico">
                    </div>

                    <div class="form-group">
                        <label style="color: #ccc;">Especialidade (Categoria)</label>
                        <select id="agentCategory" class="auth-input"
                            style="width: 100%; background: #2a2a40; color: white;">
                            <option value="tecnologia">Tecnologia & Dev</option>
                            <option value="juridico">Jurídico</option>
                            <option value="saude">Saúde</option>
                            <option value="engenharia">Engenharia</option>
                            <option value="negocios">Negócios & Finanças</option>
                            <option value="criativos">Criativos & Marketing</option>
                            <option value="educacao">Educação</option>
                            <option value="operacional">Operacional</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="color: #ccc;">Prompt do Sistema (Personalidade)</label>
                        <textarea id="agentPrompt" class="auth-input" rows="8" style="width: 100%; resize: vertical;"
                            placeholder="Defina como o agente deve se comportar, o que ele sabe e como deve responder..."></textarea>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-brain"></i> Base de Conhecimento
                        <span style="font-size: 0.8rem; color: #666; margin-left: auto;" id="fileCount">0
                            arquivos</span>
                    </div>

                    <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                        O agente usa esses arquivos para responder com precisão. Suporta PDF, DOCX e TXT.
                    </p>

                    <div class="upload-zone" id="dropZone" onclick="document.getElementById('newFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4 style="color: white; margin: 5px 0;">Arraste arquivos aqui</h4>
                        <span style="color: #666; font-size: 0.8rem;">ou clique para selecionar do computador</span>
                        <input type="file" id="newFile" style="display:none" onchange="handleFileSelect(this)">
                    </div>

                    <div id="fileListContainer" class="file-list">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando arquivos...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="script.js"></script>

    <script>
        const API_URL = (typeof BASE_URL !== 'undefined') ? BASE_URL : 'http://localhost:5217';

        // --- ÍCONES ---
        const icons = ["fa-robot", "fa-user-tie", "fa-briefcase", "fa-laptop-code", "fa-gavel", "fa-stethoscope", "fa-calculator", "fa-bullhorn", "fa-chart-line", "fa-lightbulb", "fa-pen-nib", "fa-tools", "fa-hard-hat", "fa-truck", "fa-ship", "fa-plane", "fa-camera", "fa-music", "fa-gamepad", "fa-dumbbell", "fa-utensils", "fa-book", "fa-graduation-cap", "fa-microscope", "fa-flask", "fa-seedling", "fa-paw", "fa-balance-scale", "fa-building", "fa-home"];
        const container = document.getElementById('iconContainer');
        icons.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'icon-option';
            div.innerHTML = `<i class="fas ${icon}"></i>`;
            div.onclick = () => selecionarIcone(div, icon);
            container.appendChild(div);
        });

        function selecionarIcone(element, iconClass) {
            document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedIcon').value = iconClass;
        }

        // --- CARREGAMENTO INICIAL ---
        document.addEventListener('DOMContentLoaded', carregarDados);

        async function carregarDados() {
            try {
                // 1. Agente
                const resAgent = await fetch(`${API_URL}/api/agents/${agentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!resAgent.ok) throw new Error("Erro ao carregar agente");
                const agent = await resAgent.json();

                document.getElementById('agentName').value = agent.name;
                document.getElementById('agentPrompt').value = agent.systemInstruction;
                document.getElementById('agentCategory').value = agent.specialty || 'personalizado';
                document.getElementById('selectedIcon').value = agent.icon;

                // Seleciona ícone visualmente
                document.querySelectorAll('.icon-option').forEach(el => {
                    if (el.innerHTML.includes(agent.icon)) el.classList.add('selected');
                });

                // 2. Arquivos
                carregarArquivos();

            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Não foi possível carregar os dados do agente.',
                    background: '#1a1a1a', color: '#fff'
                });
            }
        }

        async function carregarArquivos() {
            const divFiles = document.getElementById('fileListContainer');
            try {
                const resFiles = await fetch(`${API_URL}/api/knowledge/${agentId}/files`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!resFiles.ok) {
                    divFiles.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Sem permissão ou erro ao buscar arquivos.</div>';
                    return;
                }

                const files = await resFiles.json();
                divFiles.innerHTML = '';
                document.getElementById('fileCount').innerText = `${files.length} arquivo(s)`;

                if (files.length === 0) {
                    divFiles.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 30px; border: 1px dashed rgba(255,255,255,0.1); border-radius: 8px;">
                            <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p style="margin:0;">Nenhum conhecimento treinado ainda.</p>
                        </div>`;
                    return;
                }

                files.forEach(file => {
                    // Decide ícone com base na extensão (apenas visual)
                    let fileIcon = 'fa-file-alt';
                    if (file.fileName.endsWith('.pdf')) fileIcon = 'fa-file-pdf';
                    if (file.fileName.endsWith('.docx')) fileIcon = 'fa-file-word';

                    const div = document.createElement('div');
                    div.className = 'file-card';
                    div.innerHTML = `
                        <div class="file-info">
                            <i class="fas ${fileIcon} file-icon"></i>
                            <div>
                                <div style="font-weight: bold; font-size: 0.9rem;">${file.fileName}</div>
                                <div style="font-size: 0.7rem; color: #666;">Adicionado em ${new Date(file.createdAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <button onclick="excluirArquivo(${file.id})" class="btn-delete" title="Remover conhecimento">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    divFiles.appendChild(div);
                });
            } catch (e) {
                divFiles.innerHTML = '<p style="color:red; text-align:center;">Erro ao conectar com servidor.</p>';
            }
        }

        // --- SALVAR ALTERAÇÕES ---
        async function salvarAlteracoes() {
            const btn = document.querySelector('button[onclick="salvarAlteracoes()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btn.disabled = true;

            const data = {
                name: document.getElementById('agentName').value,
                prompt: document.getElementById('agentPrompt').value,
                icon: document.getElementById('selectedIcon').value,
                specialty: document.getElementById('agentCategory').value,
                creatorId: 0
            };

            try {
                const res = await fetch(`${API_URL}/api/agents/${agentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
                    Toast.fire({ icon: 'success', title: 'Agente atualizado com sucesso!' });
                } else {
                    throw new Error('Falha na atualização');
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível salvar as alterações.', background: '#1a1a1a', color: '#fff' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- EXCLUIR ARQUIVO ---
        async function excluirArquivo(fileId) {
            const confirm = await Swal.fire({
                title: 'Esquecer arquivo?',
                text: "O agente perderá o conhecimento contido neste documento.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff5555',
                cancelButtonColor: '#333',
                confirmButtonText: 'Sim, remover',
                cancelButtonText: 'Cancelar',
                background: '#1a1a1a', color: '#fff'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch(`${API_URL}/api/knowledge/file/${fileId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        carregarArquivos();
                        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                        Toast.fire({ icon: 'success', title: 'Arquivo removido' });
                    }
                } catch (e) {
                    Swal.fire('Erro', 'Falha ao remover arquivo.', 'error');
                }
            }
        }

        // --- DRAG AND DROP & UPLOAD LOGIC ---
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadArquivo(files[0]);
            }
        });

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                uploadArquivo(input.files[0]);
            }
        }

        async function uploadArquivo(file) {
            // Feedback Visual imediato
            const dropZoneOriginalContent = dropZone.innerHTML;
            dropZone.innerHTML = `<i class="fas fa-circle-notch fa-spin" style="color:#00F3FF; font-size:2rem;"></i><br><span style="color:white;">Processando ${file.name}...</span>`;
            dropZone.style.pointerEvents = 'none';

            const formData = new FormData();
            formData.append('file', file);
            // IMPORTANTE: Envia o nome atual que está no input, pois o backend usa isso para linkar (Tag/Profession)
            formData.append('profession', document.getElementById('agentName').value);
            // O backend pega o userId do token, mas se pedir explicitamente podemos mandar 0 ou omitir se o controller tratar

            try {
                const res = await fetch(`${API_URL}/api/knowledge/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.ok) {
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                    Toast.fire({ icon: 'success', title: 'Conhecimento absorvido!' });
                    carregarArquivos();
                } else {
                    const txt = await res.text();
                    try {
                        const jsonErr = JSON.parse(txt);
                        Swal.fire({ icon: 'error', title: 'Erro no Upload', text: jsonErr.message || 'Erro desconhecido', background: '#1a1a1a', color: '#fff' });
                    } catch {
                        Swal.fire({ icon: 'error', title: 'Erro no Upload', text: txt, background: '#1a1a1a', color: '#fff' });
                    }
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Erro de Conexão', text: 'Falha ao enviar arquivo.', background: '#1a1a1a', color: '#fff' });
            } finally {
                // Restaura a DropZone
                dropZone.innerHTML = `<i class="fas fa-cloud-upload-alt"></i><h4 style="color: white; margin: 5px 0;">Arraste arquivos aqui</h4><span style="color: #666; font-size: 0.8rem;">ou clique para selecionar</span><input type="file" id="newFile" style="display:none" onchange="handleFileSelect(this)">`;
                dropZone.style.pointerEvents = 'auto';
            }
        }
    </script>
</body>

</html>
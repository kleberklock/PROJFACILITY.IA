<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Agente | Facility.IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style-master.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="config.js"></script>
    
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';
        
        // Pega ID da URL
        const urlParams = new URLSearchParams(window.location.search);
        const agentId = urlParams.get('id');
        if (!agentId) window.location.href = 'gerenciar_agentes.html';
    </script>

    <style>
        .edit-container { max-width: 800px; margin: 0 auto; }
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; margin-bottom: 20px; max-height: 150px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid #333; }
        .icon-option { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #2a2a40; border-radius: 8px; cursor: pointer; color: #888; border: 2px solid transparent; }
        .icon-option:hover { background: #3a3a50; color: white; }
        .icon-option.selected { background: rgba(0, 243, 255, 0.2); border-color: #00F3FF; color: #00F3FF; }
        
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #00F3FF; }
        .file-list-item span { color: #ddd; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div id="particles-js" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1;"></div>

    <div class="layout">
        <nav class="sidebar" id="sidebar">
            <div class="logo desktop-only">FACILITY<span>.IA</span></div>
            <a href="gerenciar_agentes.html" class="nav-btn"><i class="fas fa-arrow-left"></i> Voltar</a>
        </nav>

        <main class="content">
            <div class="edit-container">
                <h2 style="color: #00F3FF; border-bottom: 1px solid #333; padding-bottom: 10px;">
                    <i class="fas fa-edit"></i> Editar Agente
                </h2>

                <div class="auth-card" style="margin-top: 20px;">
                    <label style="color: #ccc; display: block; margin-bottom: 8px;">Ícone</label>
                    <div class="icon-grid" id="iconContainer"></div>
                    <input type="hidden" id="selectedIcon">

                    <div class="form-group">
                        <label style="color: #ccc;">Nome do Agente</label>
                        <input type="text" id="agentName" class="auth-input" style="width: 100%;">
                    </div>

                    <div class="form-group">
                        <label style="color: #ccc;">Especialidade</label>
                        <select id="agentCategory" class="auth-input" style="width: 100%; background: #2a2a40; color: white;">
                            <option value="tecnologia">Tecnologia & Dev</option>
                            <option value="juridico">Jurídico</option>
                            <option value="saude">Saúde</option>
                            <option value="engenharia">Engenharia</option>
                            <option value="negocios">Negócios & Finanças</option>
                            <option value="criativos">Criativos & Marketing</option>
                            <option value="educacao">Educação</option>
                            <option value="operacional">Operacional</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="color: #ccc;">Instrução do Sistema (Prompt)</label>
                        <textarea id="agentPrompt" class="auth-input" rows="6" style="width: 100%;"></textarea>
                    </div>

                    <button onclick="salvarAlteracoes()" id="btnSalvar" class="btn-primary" style="width: 100%; background: #00F3FF; color: black; font-weight: bold;">
                        Salvar Alterações
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: white; font-size: 1.1rem; margin-bottom: 15px;">Base de Conhecimento (Arquivos)</h3>
                    
                    <div id="fileListContainer">
                        <p style="color:#666;">Carregando arquivos...</p>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                        <input type="file" id="newFile" style="display:none" onchange="uploadNovoArquivo()">
                        <button onclick="document.getElementById('newFile').click()" style="background:transparent; border: 1px dashed #666; color: #888; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Adicionar novo arquivo
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="script.js"></script>
    
    <script>
        const API_URL = (typeof BASE_URL !== 'undefined') ? BASE_URL : 'http://localhost:5217';
        
        // Ícones (Mesma lista do cadastro)
        const icons = ["fa-robot", "fa-user-tie", "fa-briefcase", "fa-laptop-code", "fa-gavel", "fa-stethoscope", "fa-calculator", "fa-bullhorn", "fa-chart-line", "fa-lightbulb", "fa-pen-nib", "fa-tools", "fa-hard-hat", "fa-truck", "fa-ship", "fa-plane", "fa-camera", "fa-music", "fa-gamepad", "fa-dumbbell", "fa-utensils", "fa-book", "fa-graduation-cap", "fa-microscope", "fa-flask", "fa-seedling", "fa-paw", "fa-balance-scale", "fa-building", "fa-home"];

        // Inicializa Grid de Ícones
        const container = document.getElementById('iconContainer');
        icons.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'icon-option';
            div.innerHTML = `<i class="fas ${icon}"></i>`;
            div.onclick = () => selecionarIcone(div, icon);
            container.appendChild(div);
        });

        function selecionarIcone(element, iconClass) {
            document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedIcon').value = iconClass;
        }

        async function carregarDados() {
            try {
                // 1. Carrega Dados do Agente
                const resAgent = await fetch(`${API_URL}/api/agents/${agentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!resAgent.ok) throw new Error("Erro ao carregar agente");
                const agent = await resAgent.json();

                document.getElementById('agentName').value = agent.name;
                document.getElementById('agentPrompt').value = agent.systemInstruction;
                document.getElementById('agentCategory').value = agent.specialty || 'personalizado';
                document.getElementById('selectedIcon').value = agent.icon;

                // Seleciona ícone visualmente
                document.querySelectorAll('.icon-option').forEach(el => {
                    if (el.innerHTML.includes(agent.icon)) el.classList.add('selected');
                });

                // 2. Carrega Arquivos
                carregarArquivos();

            } catch (error) {
                console.error(error);
                Swal.fire('Erro', 'Falha ao carregar dados.', 'error');
            }
        }

        async function carregarArquivos() {
            const divFiles = document.getElementById('fileListContainer');
            try {
                const resFiles = await fetch(`${API_URL}/api/knowledge/${agentId}/files`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if(!resFiles.ok) {
                    divFiles.innerHTML = '<p style="color:#666">Nenhum arquivo encontrado ou sem permissão.</p>';
                    return;
                }

                const files = await resFiles.json();
                divFiles.innerHTML = '';

                if (files.length === 0) {
                    divFiles.innerHTML = '<p style="color:#666; font-size:0.9rem;"><i>Nenhum arquivo treinado neste agente.</i></p>';
                    return;
                }

                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-list-item';
                    div.innerHTML = `
                        <span><i class="fas fa-file-alt"></i> ${file.fileName}</span>
                        <button onclick="excluirArquivo(${file.id})" style="background:none; border:none; color:#ff5555; cursor:pointer;" title="Remover"><i class="fas fa-trash"></i></button>
                    `;
                    divFiles.appendChild(div);
                });
            } catch (e) {
                divFiles.innerHTML = '<p style="color:red">Erro ao listar arquivos.</p>';
            }
        }

        async function salvarAlteracoes() {
            const data = {
                name: document.getElementById('agentName').value,
                prompt: document.getElementById('agentPrompt').value,
                icon: document.getElementById('selectedIcon').value,
                specialty: document.getElementById('agentCategory').value,
                creatorId: 0 // Não é usado no update, mas o model pede
            };

            try {
                const res = await fetch(`${API_URL}/api/agents/${agentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    Swal.fire('Sucesso', 'Agente atualizado!', 'success');
                } else {
                    Swal.fire('Erro', 'Falha ao atualizar.', 'error');
                }
            } catch (e) {
                Swal.fire('Erro', e.message, 'error');
            }
        }

        async function excluirArquivo(fileId) {
            const confirm = await Swal.fire({
                title: 'Remover arquivo?',
                text: "O agente deixará de usar este conhecimento.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff5555'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch(`${API_URL}/api/knowledge/file/${fileId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        carregarArquivos(); // Recarrega a lista
                        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                        Toast.fire({ icon: 'success', title: 'Arquivo removido' });
                    }
                } catch(e) { Swal.fire('Erro', 'Falha ao remover arquivo.', 'error'); }
            }
        }

        async function uploadNovoArquivo() {
            const fileInput = document.getElementById('newFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('profession', document.getElementById('agentName').value); // Usa o nome atual
            // Pega ID do usuário do token (para validar no back)
            // O backend KnowledgeController.Upload pega o userId do token, então não precisamos enviar explicitamente se o controller estiver bem feito, mas seu código original pede.
            // Vou omitir aqui e confiar que o Controller pega do token ou falha com mensagem clara.
            
            Swal.showLoading();

            try {
                const res = await fetch(`${API_URL}/api/knowledge/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.ok) {
                    Swal.fire('Sucesso', 'Arquivo enviado e processado!', 'success');
                    carregarArquivos();
                } else {
                    const txt = await res.text();
                    Swal.fire('Erro', txt, 'error');
                }
            } catch (e) {
                Swal.fire('Erro', 'Falha no upload.', 'error');
            }
            fileInput.value = ''; // Limpa input
        }

        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Configurações - Facility.IA</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Layout Sidebar + Content */
        body { display: flex; height: 100vh; overflow: hidden; margin: 0; }
        
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: radial-gradient(circle at top right, #1a1a2e 0%, #050507 100%);
            
            /* --- CENTRALIZAÇÃO --- */
            display: flex;
            flex-direction: column;
            align-items: center; /* Centraliza horizontalmente */
        }

        /* Container para os textos de cabeçalho */
        .header-container {
            width: 100%;
            max-width: 600px;
            text-align: center;
            margin-bottom: 30px;
        }

        .config-section {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            
            /* --- AJUSTE DE LARGURA --- */
            width: 100%;
            max-width: 600px;
            
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .config-title {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.9rem; }
        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
        }
        .input-group input:focus { border-color: var(--primary); outline: none; }

        .btn-save {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.3s;
            width: 100%;
        }
        .btn-save:hover { 
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4); 
            transform: translateY(-2px);
        }
        .btn-save:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-col { flex: 1; }

        @media (max-width: 768px) {
            .form-row { flex-direction: column; gap: 10px; }
            .main-content { padding: 20px; }
            .sidebar { display: none; } /* Simples hide para mobile por enquanto */
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div style="padding: 20px;">
            <h2 style="color: white; margin: 0;">FACILITY<span style="color: var(--primary);">.IA</span></h2>
        </div>
        <nav style="margin-top: 20px;">
            <a href="dashboard.html" class="nav-btn" style="display: block; padding: 15px 20px; color: #aaa; text-decoration: none;"><i class="fas fa-home"></i> Início</a>
            <a href="meus_prompts.html" class="nav-btn" style="display: block; padding: 15px 20px; color: #aaa; text-decoration: none;"><i class="fas fa-layer-group"></i> Meus Prompts</a>
            <a href="configuracoes.html" class="nav-btn active" style="display: block; padding: 15px 20px; color: white; background: rgba(255,255,255,0.05); border-right: 3px solid var(--primary); text-decoration: none;"><i class="fas fa-cog"></i> Configurações</a>
            <a href="#" onclick="fazerLogout()" class="nav-btn" style="display: block; padding: 15px 20px; color: #ff5555; text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </nav>
    </aside>

    <main class="main-content">
        <div id="toast-container" class="toast-container"></div>
        
        <div class="header-container">
            <h1 style="color: white; margin-bottom: 10px;">Minha Conta</h1>
            <p style="color: #888; margin: 0;">Gerencie suas preferências e segurança.</p>
        </div>

        <div class="config-section">
            <div class="config-title"><i class="fas fa-user-circle"></i> Perfil</div>
            
            <div class="input-group">
                <label>Nome Completo</label>
                <input type="text" id="userName" placeholder="Seu nome">
            </div>
            
            <div class="input-group" style="margin-top: 15px;">
                <label>E-mail</label>
                <input type="email" id="userEmail" placeholder="Carregando..." disabled style="opacity: 0.6; cursor: not-allowed;" title="Para alterar o e-mail, contate o suporte.">
            </div>

            <button class="btn-save" onclick="salvarPerfil()">Salvar Alterações</button>
        </div>

        <div class="config-section">
            <div class="config-title"><i class="fas fa-lock"></i> Segurança</div>
            
            <div class="input-group">
                <label>Senha Atual</label>
                <input type="password" id="oldPassword" placeholder="Digite sua senha atual">
            </div>

            <div class="form-row" style="margin-top: 15px;">
                <div class="form-col">
                    <div class="input-group">
                        <label>Nova Senha</label>
                        <input type="password" id="newPassword" placeholder="Mínimo 6 caracteres">
                    </div>
                </div>
                <div class="form-col">
                    <div class="input-group">
                        <label>Confirmar Nova Senha</label>
                        <input type="password" id="confirmPassword" placeholder="Repita a nova senha">
                    </div>
                </div>
            </div>

            <button class="btn-save" onclick="trocarSenha()">Atualizar Senha</button>
        </div>

    </main>

    <script src="config.js"></script> 
    <script src="script.js"></script>
    
    <script>
        // 1. Carregar dados do usuário ao abrir
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuthRedirect(); // Função do script.js
            
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // --- FIX: CONFIG.API_URL APLICADO ---
                const response = await fetch(`${CONFIG.API_URL}/api/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userName').value = data.name || '';
                    document.getElementById('userEmail').value = data.email || '';
                    
                    // Atualiza cache local
                    const localData = JSON.parse(localStorage.getItem('userData') || '{}');
                    localData.Name = data.name;
                    localStorage.setItem('userData', JSON.stringify(localData));
                } else {
                    // Fallback se a API falhar (usa dados do login)
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    if (userData.Name) document.getElementById('userName').value = userData.Name;
                    if (userData.Email) document.getElementById('userEmail').value = userData.Email;
                }
            } catch (error) {
                console.error("Erro ao carregar perfil:", error);
            }
        });

        // 2. Função de Salvar Perfil (Nome)
        async function salvarPerfil() {
            const newName = document.getElementById('userName').value;

            if (!newName || newName.trim().length < 3) {
                return showToast("O nome deve ter pelo menos 3 caracteres.", "error");
            }

            const btns = document.querySelectorAll('.btn-save');
            const btn = btns[0];
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                
                // --- FIX: CONFIG.API_URL APLICADO ---
                const response = await fetch(`${CONFIG.API_URL}/api/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name: newName })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast("Perfil atualizado!", "success");
                    // Atualiza LocalStorage
                    const localData = JSON.parse(localStorage.getItem('userData') || '{}');
                    localData.Name = data.user.name;
                    localStorage.setItem('userData', JSON.stringify(localData));
                } else {
                    showToast(data.message || "Erro ao atualizar.", "error");
                }
            } catch (error) {
                showToast("Erro de conexão.", "error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // 3. Função de Troca de Senha
        async function trocarSenha() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                return showToast("Preencha os campos de senha.", "error");
            }
            if (newPassword !== confirmPassword) {
                return showToast("As novas senhas não coincidem.", "error");
            }
            if (newPassword.length < 6) {
                return showToast("A nova senha deve ter no mínimo 6 caracteres.", "error");
            }

            const btns = document.querySelectorAll('.btn-save');
            const btn = btns[1]; 
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                
                // --- FIX: CONFIG.API_URL APLICADO ---
                const response = await fetch(`${CONFIG.API_URL}/api/auth/trocar-senha`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast("Senha alterada com sucesso!", "success");
                    document.getElementById('oldPassword').value = "";
                    document.getElementById('newPassword').value = "";
                    document.getElementById('confirmPassword').value = "";
                } else {
                    showToast(data.message || "Erro ao trocar senha.", "error");
                }
            } catch (error) {
                console.error(error);
                showToast("Erro de conexão.", "error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>